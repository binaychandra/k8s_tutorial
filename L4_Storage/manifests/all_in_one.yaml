# ──────────────────────────────────────────────────────────
# COMBINED: All resources in a single file (for quick setup)
# ──────────────────────────────────────────────────────────
# This uses DYNAMIC provisioning (no manual PV needed).
# Works on Docker Desktop and Minikube out of the box.
#
# Build the app image first:
#   cd L4_Storage/app
#   docker build -t storage-demo-app:v1 .
#
# Apply everything at once:
#   kubectl apply -f all-in-one.yaml
#
# Access the app:
#   http://localhost:30081
#
# Test persistence:
#   1. Write a file via the app
#   2. kubectl delete pod -l app=storage-demo
#   3. Wait for new pod → file is still there!
#
# Clean up:
#   kubectl delete -f all-in-one.yaml
# ──────────────────────────────────────────────────────────

# ========== 1. PersistentVolumeClaim (Dynamic) ==========
# No PV needed — the default StorageClass will auto-create one!
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: storage-demo-pvc
  labels:
    app: storage-demo
    lesson: L4-storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 256Mi
  # Omitting storageClassName → uses default StorageClass
  # Docker Desktop: hostpath
  # Minikube: standard

---

# ========== 2. Deployment ==========
apiVersion: apps/v1
kind: Deployment
metadata:
  name: storage-demo
  labels:
    app: storage-demo
    lesson: L4-storage
spec:
  replicas: 1
  selector:
    matchLabels:
      app: storage-demo
  template:
    metadata:
      labels:
        app: storage-demo
    spec:
      containers:
        - name: demo-app
          image: storage-demo-app:v1
          ports:
            - containerPort: 8000
          env:
            - name: APP_NAME
              value: "k8s-storage-demo"
            - name: DATA_DIR
              value: "/app/data"
            - name: STORAGE_TYPE
              value: "PersistentVolumeClaim (dynamic)"
          volumeMounts:
            - name: app-data
              mountPath: /app/data
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "200m"
      volumes:
        - name: app-data
          persistentVolumeClaim:
            claimName: storage-demo-pvc

---

# ========== 3. Service (NodePort) ==========
apiVersion: v1
kind: Service
metadata:
  name: storage-demo-service
  labels:
    app: storage-demo
    lesson: L4-storage
spec:
  type: NodePort
  selector:
    app: storage-demo
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8000
      nodePort: 30081
